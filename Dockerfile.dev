# Development stage
FROM golang:1.25.3-alpine

WORKDIR /app

# Install build dependencies and postgres client
RUN apk add --no-cache git gcc musl-dev postgresql-client

# Install Air for hot reloading and Goose for migrations
RUN go install github.com/air-verse/air@latest && \
    go install github.com/pressly/goose/v3/cmd/goose@latest && \
    chmod +x $(go env GOPATH)/bin/goose

# Copy go mod files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy the rest of the application
COPY . .

# Create migrations directory and set permissions
RUN mkdir -p /app/infra/databases/migrations && \
    chmod -R 755 /app/infra/databases/migrations

# Expose the application port
EXPOSE 8081

# Command to run the application with Air
CMD ["air", "-c", ".air.toml"]
